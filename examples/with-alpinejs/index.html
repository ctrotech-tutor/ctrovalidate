<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ctrovalidate 2.0 â€¢ Alpine.js Demo (Corrected)</title>
    <link rel="stylesheet" href="https://unpkg.com/mvp.css" />

    <style>
      body {
        padding: 2rem;
      }
      .is-invalid {
        border-color: #d92b2b;
      }
      .error-message {
        color: #d92b2b;
        font-size: 0.8rem;
      }
      .item-row {
        display: grid;
        grid-template-columns: 1fr 100px 120px;
        gap: 1rem;
        align-items: start;
        margin-bottom: 1rem;
      }
      button[disabled] {
        background-color: #ccc !important;
      }
    </style>
  </head>

  <body>
    <main>
      <h1>Dynamic Invoice</h1>

      <!-- Alpine-powered invoice form -->
      <form
        id="invoice-form"
        x-data="invoice"
        @submit.prevent="submitForm"
        novalidate
      >
        <header>
          <button type="button" @click="addItem">Add Item</button>
        </header>

        <hr />

        <!-- Dynamic item rows -->
        <template x-for="(item, index) in items" :key="item.id">
          <div class="item-row">
            <div>
              <label :for="`description-${item.id}`">Description</label>
              <input
                type="text"
                :id="`description-${item.id}`"
                :name="`description-${item.id}`"
                data-ctrovalidate-rules="required|minLength:5"
              />
              <div class="error-message"></div>
            </div>

            <div>
              <label :for="`quantity-${item.id}`">Quantity</label>
              <input
                type="number"
                :id="`quantity-${item.id}`"
                :name="`quantity-${item.id}`"
                data-ctrovalidate-rules="required|numeric|min:1"
              />
              <div class="error-message"></div>
            </div>

            <div>
              <label>&nbsp;</label>
              <button
                type="button"
                @click="removeItem(index)"
                :disabled="items.length <= 1"
              >
                Remove
              </button>
            </div>
          </div>
        </template>

        <hr />

        <button type="submit">Submit Invoice</button>
      </form>
    </main>

    <!-- Main JS: Alpine + Ctrovalidate -->
    <script type="module">
      /* ---------------------------
       IMPORT ALPINE (ESM MODULE)
    ----------------------------*/
      import Alpine from 'https://cdn.jsdelivr.net/npm/alpinejs@3.15.2/dist/module.esm.js';
      window.Alpine = Alpine;

      /* ---------------------------
       IMPORT CTROVALIDATE
    ----------------------------*/
      import { Ctrovalidate } from '../../src/index.js';

      const form = document.getElementById('invoice-form');
      const validator = new Ctrovalidate(form, { realTime: true });

      /* ---------------------------
       REGISTER ALPINE COMPONENT
    ----------------------------*/
      Alpine.data('invoice', () => ({
        items: [{ id: 1 }],
        nextId: 2,

        addItem() {
          this.items.push({ id: this.nextId++ });

          this.$nextTick(() => {
            const newId = this.items.at(-1).id;
            const desc = form.querySelector(`#description-${newId}`);
            const qty = form.querySelector(`#quantity-${newId}`);

            validator.addField(desc);
            validator.addField(qty);
          });
        },

        removeItem(index) {
          if (this.items.length <= 1) return;

          const item = this.items[index];
          const desc = form.querySelector(`#description-${item.id}`);
          const qty = form.querySelector(`#quantity-${item.id}`);

          validator.removeField(desc);
          validator.removeField(qty);

          this.items.splice(index, 1);
        },

        async submitForm() {
          const ok = await validator.validate();

          if (ok) {
            alert('Invoice is valid and ready to be submitted!');
            console.log(
              'Form Data:',
              Object.fromEntries(new FormData(form).entries())
            );
          } else {
            alert('Please correct the errors in the invoice items.');
          }
        },
      }));

      /* ---------------------------
       START ALPINE
    ----------------------------*/
      Alpine.start();
    </script>
  </body>
</html>
